log start "ssh: start"

ssh_envs

if [ -f "${SSH_AGENT_OUTPUT_SCRIPT}" ]; then
	log debug "ssh: agent script found"
	((SHELL_DEBUG)) && cat ${SSH_AGENT_OUTPUT_SCRIPT}

	log debug "ssh: sourcing agent script"
	source ${SSH_AGENT_OUTPUT_SCRIPT}
else
	log debug "ssh: agent script not found"
fi

ssh_envs

log env ssh_agent_state

if [ "$(ssh_agent_state)" = "no_connection" ]; then
	ssh_agent_kill
	ssh_agent_start
fi

ssh_envs

if [ "$(ssh_agent_state)" = "empty" ]; then
	log info "ssh: adding user keys"
	ssh-add -vvv
	ssh-add -L
	ssh-add -l
else
	log debug "ssh: keys loaded #$(ssh-add -L | wc -l)"
fi

ssh_envs

log finish "ssh: start"
