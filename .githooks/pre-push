#!/usr/bin/env bash
set -euo pipefail

repo_root="$(git rev-parse --show-toplevel)"
cd "$repo_root"

if [ "${DOTFILES_AI_DOCS_SKIP:-0}" = "1" ]; then
	echo "pre-push: IA de documentacao desabilitada por DOTFILES_AI_DOCS_SKIP=1"
	exit 0
fi

PYENV_ROOT="${PYENV_ROOT:-$HOME/.pyenv}"
if [ -x "$PYENV_ROOT/bin/pyenv" ]; then
	export PYENV_ROOT
	export PATH="$PYENV_ROOT/shims:$PYENV_ROOT/bin:$PATH"
	if [ -z "${PYENV_VERSION:-}" ] && [ -f ".python-version" ]; then
		PYENV_VERSION="$(head -n 1 .python-version | tr -d '[:space:]')"
		export PYENV_VERSION
	fi
fi

python_cmd=()
if command -v pyenv >/dev/null 2>&1; then
	python_cmd=("pyenv" "exec" "python")
elif command -v python3 >/dev/null 2>&1; then
	python_cmd=("python3")
elif command -v python >/dev/null 2>&1; then
	python_cmd=("python")
else
	echo "pre-push: erro: python nao encontrado para executar o sync de documentacao."
	exit 1
fi

"${python_cmd[@]}" "$repo_root/bin/docs_ai_sync_pre_push.py" --remote-name "${1:-}" --remote-url "${2:-}"
